<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE exportmultiplex SYSTEM "jar:/mz/dtd/export_multiplex.dtd">
<exportmultiplex category="APL_Source_Code" ref_path="apl_script[Internal]/storable[apl_script]/storable[Data]">
   <string name="Definition"><![CDATA[//common
import ultra.CBS.UFL_DSP_Header;
import ultra.CBS.UFL_MBASE_Header;
import apl.Common.APL_Common_MBASE;
import ultra.Ultra.UFL_MBASE_Reject;
import apl.Common.APL_Common_Utilities;
//wsdl
import ultra.ws.CBS.PRF_WS_CBSLoanService.cycles;
import ultra.ws.CBS.PRF_WS_CBSLoanService.tns;
//ultra
import ultra.Ultra.UFL_MBASE_LN86309;
import ultra.Ultra.UFL_MBASE_LN83102;
final int sizeOf_LN86309 = 20;
final int sizeOf_LN83102 = 35;
bytearray createContentMessageLN86309_GetLoanAccountDetail(string uniqKey,WSCycle_getLoanAccountDetail request){
   //DSP Header
    DSP_Header_TgIn dspHeader = createDefaultDSPHeader();
    dspHeader.SKTMLEN = sizeOf_DSPHeader + sizeOf_MBaseHeader + sizeOf_LN86309 - 9;
    dspHeader.I13FMID = "MBASE";  
    dspHeader.I13DID = "CIFI";
    dspHeader.I13SID = request.param_Header.ChannelID + "##";
    //dspHeader.I13ACQN = uniqKey;  
    dspHeader.I13ACQN = strSubstring(uniqKey, 0, 12);  
    dspHeader.I13TMNO = strSubstring(uniqKey, 12, 16);  
         
    //MBASE Header
    MBASE_Header_TI mbaseHeader = createDefaultMBASEHeader();
    mbaseHeader.HDTCOD = "LN86309";
    mbaseHeader.HDDSID = request.param_Header.ChannelID; // ESB 
    mbaseHeader.HDACCD = "I";
    mbaseHeader.HDNREC = "20"; // record max 20 
    mbaseHeader.HDUSID = request.param_Header.ChannelID + "USR";

    if(request.param_Paging.NextPageIndicator!=""){
        mbaseHeader.HDMREC = "Y";     
        mbaseHeader.HDVFMT = request.param_Paging.NextPageIndicator;   
    }

    //Request Data
    MBASE_LN86309_RQ_TI mbaseRequest = udrCreate(MBASE_LN86309_RQ_TI);
    mbaseRequest.ACCTNO_AccountNumber = request.param_Data.AccountNumber;
    mbaseRequest.ACTYPE_AccountType = "L";
    
    
    
    //Build Socket Message
    bytearray outgoing = udrEncode("DSP_Header_Encoder", dspHeader);
    outgoing = baAppend(outgoing, udrEncode("MBASE_Header_Encode", mbaseHeader));
    outgoing = baAppend(outgoing, udrEncode("MBASE_LN86309_RQ_Encode", mbaseRequest));
    return outgoing;
}

WSCycle_getLoanAccountDetail responseMessageLN86309_GetLoanAccountDetail(WSCycle_getLoanAccountDetail responseMessage,DSP_Header_TgIn tcpResponse,long requestMillisec,boolean errorUDR){
    if(errorUDR==false){
        list<MBASE_Header_With_Payload_TI> aList = listCreate(MBASE_Header_With_Payload_TI);
        udrDecode("MBASE_Header_With_Payload_Decode", aList, tcpResponse.data);
        MBASE_Header_With_Payload_TI mbase = listGet(aList,0);
        
        //debug(mbase);
        //debug("MBase Header:" + mbase.mbaseHeader);
        debug("TransCode: " + mbase.mbaseHeader.HDTCOD);
        debug("DSP status: " + tcpResponse.I13MSTA);
        debug("MBase Data:" + baToStr(mbase.data, "IBM-Thai"));
        
        bytearray refilled = refillTrimedColumn(mbase.data,1560);   
        //debug("MBASE Data refilled:" + baToStr(refilled, "IBM-Thai")); 
        
        //Response Header
        responseMessage.param_Header_01 = udrCreate(GetLoanAccountDetailResponse$Header);
        date responseTransactinDatetime = dateCreateCopy(responseMessage.param_Header.TransactionDateTime);
        dateSetTimeZone(responseTransactinDatetime, "GMT+7");       
        responseMessage.param_Header_01.ReferenceNo = responseMessage.param_Header.ReferenceNo;
        responseMessage.param_Header_01.TransactionDateTime = responseTransactinDatetime;
        responseMessage.param_Header_01.ChannelID = responseMessage.param_Header.ChannelID;
        
        //Response StatusInfo
        responseMessage.param_Header_01.StatusInfo = udrCreate(GetLoanAccountDetailResponse$Header$StatusInfo);
        responseMessage.param_Header_01.StatusInfo.Status = udrCreate(GetLoanAccountDetailResponse$Header$StatusInfo$Status);
        responseMessage.param_Header_01.StatusInfo.Status.UsageTime = dateCreateNowMilliseconds()-requestMillisec;
        
        //Request Data AccountList 
        if(!strStartsWith(tcpResponse.I13MSTA, ".DSP")){
            if(mbase.mbaseHeader.HDRIND == "AA"){
                //Success
                debug("AA");
                list<MBASE_LN86309_RS_TI> AccountInfo = listCreate(MBASE_LN86309_RS_TI);
                udrDecode("MBASE_LN86309_RS_Decode", AccountInfo, refilled);
                MBASE_LN86309_RS_TI account = listGet(AccountInfo,0);
                
                GetLoanAccountDetailResponse$Header$LoanAccountInfo$LoanAccount acco = udrCreate(GetLoanAccountDetailResponse$Header$LoanAccountInfo$LoanAccount);
                acco.AccountName = getStringValue(account.ACName_AccountName);
                acco.AccountNumber = getStringValue(account.ACCTNO_AccountNumber);
                acco.AccountStatus = "";
                acco.AccountType = getStringValue(account.ACTYPE_AccountType);
                strToDouble(acco.AccumulateTopUpAmount, convertToNumberic(account.LLALLS_AccumulateTopUpAmt,17,2));
                acco.AdditionalReferenceNumber = getStringValue(account.LHAREF_AdditionalRefNo);
                acco.Address = "";
                acco.AFTDebitAccountNumber = getStringValue(account.DRACCT_AFTDebitAccountNo);
                acco.AFTDebitAccountType = getStringValue(account.DRTYPE_AFTDebitAccountType);
                acco.AFTTransferFlag =  getStringValue(account.AFTCDE_AFTIndicator);
                strToLong(acco.AgingByDays,getStringValue(account.PSTDAY_AgingByDays));
                acco.AgingHistoryNumberOfDayDraftInterest = getStringValue(account.LFID_AgingHistoryNoOfDayDFTIN);              
                acco.AgingHistoryNumberOfDayDraftPrincipal = getStringValue(account.LFPD_AgingHistoryNoOfDayDFTPR);           
                acco.ApprovedName = getStringValue(account.AFAPPR_ApprovedName);                  
                strToDouble(acco.AvailableLimit, convertToNumberic(account.AVALMT_AvailableLimit,17,2));                
                //acco.BilledInterestODAmount = "";            
                //acco.BilledLateCharge = "";                
                //acco.BilledMiscCostOD = "";                  
                //acco.BilledMoratoriumInterest = "";               
                //acco.BilledOtherChargesOD = "";       
                strToDouble(acco.BilledPrincipleODAmount, convertToNumberic(account.BILPNO_BilledPrinAmtOD,17,2));                          
                //acco.BilledRestructureInterest = "";                    
                strToDouble(acco.BilledTotalOriginalAmount, convertToNumberic(account.LBTAMO_OrgBilledTotalAmount,17,2));
                strToDouble(acco.BilledTotalOutstandingAmount, convertToNumberic(account.LBTAMT_OSBilledTotalAmount,17,2));                       
                //acco.BillInterest = "";                             
                //acco.BirthDate = "";                                       
                acco.BranchName = getStringValue(account.WJDNAME_BranchName);                                            
                strToLong(acco.BranchNumber,getStringValue(account.BRN_BranchNumber));                                         
                acco.CampaignCode = getStringValue(account.AAPCOD_CampaignCode);
                strToDate(acco.CampaignExpiredDate, getStringValue(account.CAMDT8_CampaignExpiredDate), "yyyyMMdd", "GMT+7");
                //acco.CampaignInterestRatePercentage= "";     
                //acco.CampaignPrimeRateNumber= "";     
                acco.CampaignPrimeVarianceCode= "";     
                //acco.CampaignPrimeVariancePercentage= "";     
                acco.CommercialPaperNumber = getStringValue(account.AFCPNO_CPNo);
                acco.CreditTerm = getStringValue(account.CRDTRM_CreditTerm);
                strToDouble(acco.CurrentBalance, convertToNumberic(account.CBAL_CurrentBalance,17,2));     
                acco.CustomerNumber = padCustomerNumber(getStringValue(account.CIFNO_CIFNumber),9);
                strToDate(acco.CycleStatementInterestDueDate, getStringValue(account.NIPDAY_CycleStatementInterestDueDate), "yyyyMMdd", "GMT+7");
                strToDate(acco.CycleStatementPaymentDueDate, getStringValue(account.NPDAY_CycleStatementPaymentDueDate), "yyyyMMdd", "GMT+7");
                strToDouble(acco.DailyAccrual, convertToNumberic(account.PDIEM_DailyAccrual,17,2));
                strToDouble(acco.DailyAccrual2, convertToNumberic(account.ACCINT_DailyAccrual,17,2));
                strToDate(acco.DateOfInterestSuspensedBegin, getStringValue(account.SUPDT8_DateOfInterestSuspensedBeg), "yyyyMMdd", "GMT+7");
                strToDate(acco.DateStopCalculateInterest, getStringValue(account.STOPD8_DateStopCalculateInterest), "yyyyMMdd", "GMT+7");
                acco.Description = getStringValue(account.LEPDSC_Description);
                
                double DiscountPromotionRatePercentage;
                strToDouble(DiscountPromotionRatePercentage , convertToNumberic(account.DCPRT_DiscountPromotionRate,11,9));    
                acco.DiscountPromotionRatePercentage = (DiscountPromotionRatePercentage*100);
                
                strToDouble(acco.DrawingLimit, convertToNumberic(account.DRLIMT_DrawingLimit,17,2));                                                 
                strToDouble(acco.DrawingLimit2, convertToNumberic(account.AFLIMT_DrawingLimit,17,2));               
                strToDouble(acco.EarmarkAmount, convertToNumberic(account.HOLD_EarmarkAmount,17,2));                                                                                           
                strToDate(acco.ExpiryEarlyClosedDate, getStringValue(account.EXPECD_ExpiryEarlyClosedDate), "yyyyMMdd", "GMT+7");                                                                                                                                          
                acco.FacilityCode = getStringValue(account.AFFCDE_FacilityCode);                                                                                                                                                                                               
                acco.FacilityID = "";
                acco.FacilityStatus = getStringValue(account.AFSTAT_FacilityStatus);                                                                                                                                                                                                                                          
                acco.FacilityType = getStringValue(account.LKFTYP_FacilityType);                                                                                                                                                                                                                                                                                              
                strToDouble(acco.FeeChargeThisMonth, convertToNumberic(account.DEBFEE_FeeChargeThisMonth,17,2));                                                                                                                                                                                                                                                                                                                                                    
                acco.FirstPaymentChannel = getStringValue(account.FLPAYF_FirstPaymentChannel);                                                                                                                                                                                                                                                                                                                                                                                              
                //acco.FirstPaymentDate = "";                                                                                                                                                                                                                                                                                                                                                                                                                                              
                acco.FirstReleaseChannel = getStringValue(account.FLPAYT_FirstReleaseChannel);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                //acco.FirstReleaseDate = "";                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                strToDouble(acco.FullChequeAmount, convertToNumberic(account.FULLCHQ_FullChequeAmount,17,2));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                //acco.FullReleaseDate = "";                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                acco.HoldMailCode = getStringValue(account.HMAIL_HoldMailCode);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                //acco.IDIssueCountryCode = "";                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                //acco.IDNumber = "";                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                //acco.IDTypeCode = "";                                                  
                strToDouble(acco.InterestFeeReceiveeYear, convertToNumberic(account.YTDFEE_InterestFeeReceiveeYear,17,2));                                              
                //acco.InterestPaidtoDate = "";                                                    
                acco.InterestPaymentFrequency = getStringValue(account.IPFREQ_IntPaymentFrequency);                                               
                acco.InterestPaymentFrequencyCode = getStringValue(account.IPCODE_IntPaymentFreqCode);                                           
                //acco.InterestRatePercentage = "";                                                                     
                strToDouble(acco.InterestSuspensedAccrued, convertToNumberic(account.SUPINT_InterestSuspensedAccrued,17,2));               
                strToDouble(acco.InterestSuspensedReverseIncome, convertToNumberic(account.IISTAX_InterestSuspensedReverseInc,17,2));                                                                
                strToDate(acco.LastCalculateInterestDate, getStringValue(account.LSTCID_LastCalculateInterest), "yyyyMMdd", "GMT+7");                                                                                                                           
                //acco.LastPaymentAmount = "";                                                                                                                                                                                            
                //acco.LastReceiptNumber = "";                                                                                                                                                                                                                                                             
                acco.LastReleaseChannel = getStringValue(account.LLPAYT_LastReleaseChannel);                                                                                                                                                                                                                                                                                                                      
                strToDate(acco.LastReleaseDate, getStringValue(account.LRELD8_LastReleaseDate), "yyyyMMdd", "GMT+7");                                                                                                                                                                                                                                                                                                                                                                                   
                strToDate(acco.LastStatementDate, getStringValue(account.LPDT8_LastStatementDate), "yyyyMMdd", "GMT+7");                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                strToDouble(acco.LastTopUpAmount, convertToNumberic(account.LLALLT_LastTopUpAmount,17,2));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                strToDate(acco.LastTopUpCampaignDate, getStringValue(account.LLALD8_LastTopUpCampaign), "yyyyMMdd", "GMT+7");                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                strToDouble(acco.LateChargeAmount, convertToNumberic(account.LATFEE_LateCharge,17,2));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                strToDouble(acco.LimitUsedAmount, convertToNumberic(account.AFUSE_LimitUsedAmount,17,2));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                strToLong(acco.LoanTerm,getStringValue(account.TERM_LoanTerm));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                //acco.LoanTerm2 = "";                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                acco.LoanTermCode = getStringValue(account.TMCODE_LoanTermCode);
                //acco.LoanTermCode2 = "";                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                acco.LoanType = getStringValue(account.TYPE_LoanType);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                strToDate(acco.ManagerApprovalDate, getStringValue(account.AFARD8_DateOfMgmtApproval), "yyyyMMdd", "GMT+7");                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                strToDate(acco.MaturityDate, getStringValue(account.MATDT8_MaturityDate), "yyyyMMdd", "GMT+7");                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                
                double MaximumInterestRatePercentage;
                strToDouble(MaximumInterestRatePercentage, convertToNumberic(account.LCMRAT_InterestRateMaximum,11,9));   
                acco.MaximumInterestRatePercentage = (MaximumInterestRatePercentage*100);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                strToDouble(acco.MonthlyAccruedInterestSuspensed, convertToNumberic(account.SPEARN_MonthlyAccruedInterestSuspend,17,2));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                strToDouble(acco.MonthToDatePaymentsReceivedAmount, convertToNumberic(account.MTDPMR_MTDPaymentsReceived,17,2));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                strToDouble(acco.NewPaymentAmount, convertToNumberic(account.LPWPMT_NewPaymentAmount,17,2));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                acco.NewPaymentCondition = getStringValue(account.LPWCOD_NewPaymentCondition);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                strToDate(acco.NewPaymentConditionDate, getStringValue(account.LPWDU8_NewPaymentConditionDate), "yyyyMMdd", "GMT+7");                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                //acco.NonTaxableInterestInSuspensed = "";                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                //acco.NPLDate = "";                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                acco.NPLStatus = "";                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                strToLong(acco.NumberOfLimitLine,getStringValue(account.NOFAC_NoOfLimitLine));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                //acco.NumberOfPaymentPastDue = "";                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                //acco.OriginalBalance = "";                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                strToDate(acco.OriginalLoanDate, getStringValue(account.ORGDT8_OriginalLoanDate), "yyyyMMdd", "GMT+7");                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                strToDouble(acco.OtherFeeAmount, convertToNumberic(account.FEEOTH_OtherFeeAmount,17,2));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                strToDouble(acco.OutstandingBalanceAmount, convertToNumberic(account.CURPO_OutstandingBalanceAmt,17,2));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                strToDouble(acco.OutstandingInterestUnpaidAccrued, convertToNumberic(account.OSINT_OSInterest,17,2));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                acco.PartOfAccount = getStringValue(account.PP_PartOfAccount);                                                                
                acco.PaymentCode = getStringValue(account.PMTCOD_PaymentCode); 
                strToDate(acco.PaymentDueDate, getStringValue(account.NPDT8_PaymentDueDate), "yyyyMMdd", "GMT+7");
                acco.PaymentFreqCode = getStringValue(account.FRCODE_PaymentFreqCode);
                acco.PaymentFrequency = getStringValue(account.FREQ_PaymentFrequency);
                strToDate(acco.PaymentInterestDueDate, getStringValue(account.NIPDT8_PaymentInterestDueDate), "yyyyMMdd", "GMT+7");
                acco.PhoneNumber = "";
                acco.PrimeRateNumber = getStringValue(account.PRATEN_PrimeRateNumber);
                acco.PrimeVarianceCode = getStringValue(account.PVCODE_PrimeVarianceCode);
                
                double PrimeVariancePercentage;
                strToDouble(PrimeVariancePercentage, convertToNumberic(account.PVARI_PrimeVariance,11,9)); 
                acco.PrimeVariancePercentage = (PrimeVariancePercentage*100);
                      
                acco.ProjectCode = getStringValue(account.AFPJCD_ProjectCode);
                strToDouble(acco.ReceivableLifeToDateInterest, convertToNumberic(account.TOTIN_InterestReceivableLTD,17,2));
                strToDouble(acco.ReceivedMonthToDateInterest, convertToNumberic(account.MTDIP_InterestReceivedMTD,17,2));
                acco.ShortDescription = getStringValue(account.PSHDSC_ShortDescription);
                strToLong(acco.StandardRateNumber,getStringValue(account.STDRTN_StandardRateNumber)); 
                
                double StandardRatePercentage;
                strToDouble(StandardRatePercentage, convertToNumberic(account.STDRAT_StandardRate,11,9));
                acco.StandardRatePercentage = (StandardRatePercentage*100);
                
                acco.StandardRateVarianceCode = getStringValue(account.STDVAC_StandardRateVarianceCode);
                
                double StandardRateVariancePercentage;
                strToDouble(StandardRateVariancePercentage, convertToNumberic(account.STDRAT_StandardRate,11,9));
                acco.StandardRateVariancePercentage = (StandardRateVariancePercentage*100);
                
                strToDate(acco.StatementInterestPaymentDueDate, getStringValue(account.NSIPD8_StatementIntPaymentDueDate), "yyyyMMdd", "GMT+7");
                strToDate(acco.StatementPaymentDueDate, getStringValue(account.NSPDT8_StatementPaymentDueDate), "yyyyMMdd", "GMT+7");
                strToDouble(acco.StatementTotalDue, convertToNumberic(account.LBTATT_StatementTotalDue,17,2));
                strToDouble(acco.StatementTotalDueOutstanding, convertToNumberic(account.LBTAOT_StatementTotalDueOS,17,2));
                strToDate(acco.TopUpApprovedDate, getStringValue(account.LLALA8_TopUpApprovedDate), "yyyyMMdd", "GMT+7");
                strToDouble(acco.TotalAdvanceFeeAmount, convertToNumberic(account.OTHCHG_TotalAdvanceFeeAmount,17,2));
                acco.TotalDelinquencyNumberAndActiveDelinquency = getStringValue(account.DELDSC_TotalDelinquencyNoTotalAC);
                strToDouble(acco.TotalFeeChargeAmount, convertToNumberic(account.FEEAMT_TotalFeeChargeAmount,17,2));
                strToDouble(acco.TotalFeePrintStatementReady, convertToNumberic(account.BILFEE_TotalFeePrintStatementRead,17,2));
                strToDouble(acco.TotalPrePaymentTodayAmount, convertToNumberic(account.TODPMR_TotalPrepaymentToday,17,2));
                strToDouble(acco.UnutilizedLimit, convertToNumberic(account.UNUSE_UnutilizedLimit,17,2));
                strToDouble(acco.UnutilizeLimit, convertToNumberic(account.AFUNUSE_UnutilizeLimit,17,2));
                strToDouble(acco.UsedLimit, convertToNumberic(account.USEAMT_UsedLimit,17,2));
                strToDouble(acco.YearToDateMaximumIncome, convertToNumberic(account.YTDMXI_YTDMaximumIncome,17,2));
                strToDouble(acco.YesterdayChequeAmount, convertToNumberic(account.YESCHQ_YesterdayChequeAmount,17,2));
                strToDouble(acco.YesterdayCurrentBalance, convertToNumberic(account.YSCBAL_YesterdayCurrentBalance,17,2));
                                                                                                                                                                                                                         
        
            }else{
                //Rejected
                //Get Mbase Reject
                list<MBASE_Reject_With_Payload_TI> aRejected = listCreate(MBASE_Reject_With_Payload_TI);
                udrDecode("MBASE_Reject_With_Payload_Decode", aRejected, mbase.data);
                MBASE_Reject_With_Payload_TI rejected = listGet(aRejected,0);
                
                responseMessage.param_Header_01.StatusInfo.Status.Success = false;
                responseMessage.param_Header_01.StatusInfo.Status.ResponseCode = rejected.mbaseReject.ErrorCode;
                responseMessage.param_Header_01.StatusInfo.Status.ResponseMessage = baToStr(rejected.errorDesc, "IBM-Thai");
            }
        }else{
                if(strStartsWith(tcpResponse.I13MSTA, ".DSP")){
                    //Response Stattus Info
                    string responseCodeDSP = strREReplaceAll(tcpResponse.I13MSTA, "\\.", "");
                    responseMessage.param_Header_01.StatusInfo.Status.Success = false;
                    responseMessage.param_Header_01.StatusInfo.Status.ResponseCode = responseCodeDSP;
                    responseMessage.param_Header_01.StatusInfo.Status.ResponseMessage = getDSPErrorDesc(responseCodeDSP);       
                }
                else{
                    //DSP Service down 
                    responseMessage.param_Header_01.StatusInfo.Status.Success = false;
                    responseMessage.param_Header_01.StatusInfo.Status.ResponseCode = "CBS8999";
                    responseMessage.param_Header_01.StatusInfo.Status.ResponseMessage = "Unknow data format (Invalid response from host)";     
                }
        }
    }else{
           
                //Response Header
                responseMessage.param_Header_01 = udrCreate(GetLoanAccountDetailResponse$Header);
                date responseTransactinDatetime = dateCreateCopy(responseMessage.param_Header.TransactionDateTime);
                dateSetTimeZone(responseTransactinDatetime, "GMT+7");       
                responseMessage.param_Header_01.ReferenceNo = responseMessage.param_Header.ReferenceNo;
                responseMessage.param_Header_01.TransactionDateTime = responseTransactinDatetime;
                responseMessage.param_Header_01.ChannelID = responseMessage.param_Header.ChannelID;
                //Response StatusInfo
                responseMessage.param_Header_01.StatusInfo = udrCreate(GetLoanAccountDetailResponse$Header$StatusInfo);
                responseMessage.param_Header_01.StatusInfo.Status = udrCreate(GetLoanAccountDetailResponse$Header$StatusInfo$Status);
                responseMessage.param_Header_01.StatusInfo.Status.UsageTime = dateCreateNowMilliseconds()-requestMillisec;
                responseMessage.param_Header_01.StatusInfo.Status.Success = false;
                responseMessage.param_Header_01.StatusInfo.Status.ResponseCode = "CBS8990";
                responseMessage.param_Header_01.StatusInfo.Status.ResponseMessage = "Connection to CBS lost";
    }
    return responseMessage;
}
bytearray createContentMessageLN83102_InquiryLoanStatementHistory(string uniqKey,WSCycle_inquiryLoanStatementHistory request){
    //DSP Header
    DSP_Header_TgIn dspHeader = createDefaultDSPHeader();
    dspHeader.SKTMLEN = sizeOf_DSPHeader + sizeOf_MBaseHeader + sizeOf_LN83102 - 9;
    dspHeader.I13FMID = "MBASE";  
    dspHeader.I13DID = "LNSI";
    dspHeader.I13SID = request.param_Header.ChannelID + "##";
    //dspHeader.I13ACQN = uniqKey;  
    dspHeader.I13ACQN = strSubstring(uniqKey, 0, 12);  
    dspHeader.I13TMNO = strSubstring(uniqKey, 12, 16); 
         
    //MBASE Header
    MBASE_Header_TI mbaseHeader = createDefaultMBASEHeader();
    mbaseHeader.HDTCOD = "LN83102";
    mbaseHeader.HDDSID = "ESB";
    mbaseHeader.HDACCD = "I";
    mbaseHeader.HDNREC = "20";
    
    if(request.param_Paging.NextPageIndicator!=""){
        mbaseHeader.HDMREC = "Y";     
        mbaseHeader.HDVFMT = request.param_Paging.NextPageIndicator;   
    }
    
    //Request Data
    MBASE_LN83102_RQ_TI mbaseRequest = udrCreate(MBASE_LN83102_RQ_TI);    
    mbaseRequest.ACCTNO_LoanAccountNumber = request.param_Data.AccountNumber;
    
    
    //Combine socket message
    bytearray outgoing = udrEncode("DSP_Header_Encoder", dspHeader);
    outgoing = baAppend(outgoing, udrEncode("MBASE_Header_Encode", mbaseHeader));
    outgoing = baAppend(outgoing, udrEncode("MBASE_LN83102_RQ_Encode", mbaseRequest));
    
    return outgoing;
}

WSCycle_inquiryLoanStatementHistory responseMessage_InquiryLoanStatementHistory(WSCycle_inquiryLoanStatementHistory responseMessage,DSP_Header_TgIn tcpResponse, long requestMillisec,boolean errorUDR){
    if(errorUDR==false){
        //debug(requestMillisec);
        
        long endTime = dateCreateNowMilliseconds();
 
        list<MBASE_Header_With_Payload_TI> aList = listCreate(MBASE_Header_With_Payload_TI);
        udrDecode("MBASE_Header_With_Payload_Decode", aList, tcpResponse.data);
        MBASE_Header_With_Payload_TI mbase = listGet(aList,0);
        bytearray refilled = refillTrimedColumn(mbase.data,387);   
        //debug(mbase);
        //debug("MBase Header:" + mbase.mbaseHeader);
        debug("TransCode: " + mbase.mbaseHeader.HDTCOD);
        debug("DSP status: " + tcpResponse.I13MSTA);
        debug("MBase Data:" + baToStr(mbase.data, "IBM-Thai"));
        
        //Declare Response object
        responseMessage.param_Header_01 = udrCreate(InquiryLoanStatementHistoryResponse$Header);
        
        //Response Header
        date responseTransactinDatetime = dateCreateCopy(responseMessage.param_Header.TransactionDateTime);
        dateSetTimeZone(responseTransactinDatetime, "GMT+7");       
        responseMessage.param_Header_01.ReferenceNo = responseMessage.param_Header.ReferenceNo;
        responseMessage.param_Header_01.TransactionDateTime = responseTransactinDatetime;
        responseMessage.param_Header_01.ChannelID = responseMessage.param_Header.ChannelID;
        
        //Response StatusInfo
        responseMessage.param_Header_01.StatusInfo = udrCreate(InquiryLoanStatementHistoryResponse$Header$StatusInfo);
        responseMessage.param_Header_01.StatusInfo.Status = udrCreate(InquiryLoanStatementHistoryResponse$Header$StatusInfo$Status);
        responseMessage.param_Header_01.StatusInfo.Status.UsageTime = endTime - requestMillisec;
        
        if(!strStartsWith(tcpResponse.I13MSTA, ".DSP")){
            if (mbase.mbaseHeader.HDRIND == "AA") {
                //debug("AA");
                responseMessage.param_Header_01.LoanStatementList = udrCreate(InquiryLoanStatementHistoryResponse$Header$LoanStatementList);
                responseMessage.param_Header_01.LoanStatementList.LoanStatement = listCreate(InquiryLoanStatementHistoryResponse$Header$LoanStatementList$LoanStatement);  
                
                //bytearray refilled = refillTrimedColumn(mbase.data,95);
                
                //Declare Customer List
                list<MBASE_LN83102_RS_TI> loanStatementList = listCreate(MBASE_LN83102_RS_TI);
                udrDecode("MBASE_LN83102_RS_Decode", loanStatementList, refilled); //use refilled
                MBASE_LN83102_RS_TI resTrans = listGet(loanStatementList,0);
                
                for(MBASE_LN83102_RS_TI loanstatement : loanStatementList){
                    
                    InquiryLoanStatementHistoryResponse$Header$LoanStatementList$LoanStatement trns = udrCreate(InquiryLoanStatementHistoryResponse$Header$LoanStatementList$LoanStatement);
                    trns.AccountNumber = accountNumberFormat(getStringValue(loanstatement.ACCTNO_LoanAccountNumber),"L");
                    strToDate(trns.EffectiveDate, getStringValue(loanstatement.LHEFD8_EffectiveDate), "yyyyMMdd", "GMT+7");
                    strToDouble(trns.InterestPaymentAmount, convertToNumberic(loanstatement.LPIPMT_InterestPaymentAmount,17,2));
                    trns.LoanTypeDescription = "";
                    //trns.OtherPaymentAmount = "";
                    //trns.PenaltyPaymentAmount = "";
                    strToDate(trns.PostingDate, getStringValue(loanstatement.LHPST8_PostingDate), "yyyyMMdd", "GMT+7");
                    strToDouble(trns.PrincipalOutstanding, convertToNumberic(loanstatement.CBAL_PrincipalBal,17,2));
                    strToDouble(trns.PrincipalPaymentAmount, convertToNumberic(loanstatement.LPPPMT_PrincipalPaymentAmount,17,2));
                    trns.ReceiptNumber = getStringValue(loanstatement.LHRCPT_ReceiptNumber); 
                    //trns.ReleaseAmount = ""
                    
                    listAdd(responseMessage.param_Header_01.LoanStatementList.LoanStatement,trns);           
                }
                
                responseMessage.param_Header_01.StatusInfo.Status.Success = true;
                responseMessage.param_Header_01.StatusInfo.Status.ResponseCode = mbase.mbaseHeader.HDRIND;
                responseMessage.param_Header_01.StatusInfo.Status.ResponseMessage = "Success";
            }else{
                //Get Mbase Reject
                list<MBASE_Reject_With_Payload_TI> aRejected = listCreate(MBASE_Reject_With_Payload_TI);
                udrDecode("MBASE_Reject_With_Payload_Decode", aRejected, mbase.data);
                MBASE_Reject_With_Payload_TI rejected = listGet(aRejected,0);
                
                responseMessage.param_Header_01.StatusInfo.Status.Success = false;
                responseMessage.param_Header_01.StatusInfo.Status.ResponseCode = rejected.mbaseReject.ErrorCode;
                responseMessage.param_Header_01.StatusInfo.Status.ResponseMessage = baToStr(rejected.errorDesc, "IBM-Thai");
            }
        }else{
                if(strStartsWith(tcpResponse.I13MSTA, ".DSP")){
                    //Response Stattus Info
                    string responseCodeDSP = strREReplaceAll(tcpResponse.I13MSTA, "\\.", "");
                    responseMessage.param_Header_01.StatusInfo.Status.Success = false;
                    responseMessage.param_Header_01.StatusInfo.Status.ResponseCode = responseCodeDSP;
                    responseMessage.param_Header_01.StatusInfo.Status.ResponseMessage = getDSPErrorDesc(responseCodeDSP);       
                }
                else{
                    //DSP Service down 
                    responseMessage.param_Header_01.StatusInfo.Status.Success = false;
                    responseMessage.param_Header_01.StatusInfo.Status.ResponseCode = "CBS8999";
                    responseMessage.param_Header_01.StatusInfo.Status.ResponseMessage = "Unknow data format (Invalid response from host)";     
                }
        }
    }else{
           
                //Response Header
                responseMessage.param_Header_01 = udrCreate(InquiryLoanStatementHistoryResponse$Header);
                date responseTransactinDatetime = dateCreateCopy(responseMessage.param_Header.TransactionDateTime);
                dateSetTimeZone(responseTransactinDatetime, "GMT+7");       
                responseMessage.param_Header_01.ReferenceNo = responseMessage.param_Header.ReferenceNo;
                responseMessage.param_Header_01.TransactionDateTime = responseTransactinDatetime;
                responseMessage.param_Header_01.ChannelID = responseMessage.param_Header.ChannelID;
                //Response StatusInfo
                responseMessage.param_Header_01.StatusInfo = udrCreate(InquiryLoanStatementHistoryResponse$Header$StatusInfo);
                responseMessage.param_Header_01.StatusInfo.Status = udrCreate(InquiryLoanStatementHistoryResponse$Header$StatusInfo$Status);
                responseMessage.param_Header_01.StatusInfo.Status.UsageTime = dateCreateNowMilliseconds()-requestMillisec;
                responseMessage.param_Header_01.StatusInfo.Status.Success = false;
                responseMessage.param_Header_01.StatusInfo.Status.ResponseCode = "CBS8990";
                responseMessage.param_Header_01.StatusInfo.Status.ResponseMessage = "Connection to CBS lost";
    }    
    return responseMessage;
}
]]></string>
</exportmultiplex>
